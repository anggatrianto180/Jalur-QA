<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jalur QA - Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        pre { background-color: #2d3748; color: #e2e8f0; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; font-size: 0.9em; }
        code { font-family: 'Courier New', Courier, monospace; background-color: #e2e8f0; padding: 0.1rem 0.3rem; border-radius: 0.25rem; }
        pre code { background-color: transparent; padding: 0; border-radius: 0; }
        html { scroll-behavior: smooth; }
        .admin-sidebar-link { display: flex; align-items: center; padding: 0.75rem 1rem; border-radius: 0.5rem; transition: background-color 0.2s ease-in-out; cursor: pointer; }
        .admin-sidebar-link:hover, .admin-sidebar-link.active { background-color: #3b82f6; color: white; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <header class="bg-gray-900 text-white shadow-md sticky top-0 z-50">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <a href="index.html" class="text-2xl font-bold text-white hover:text-gray-200">Jalur QA</a>
                <span class="hidden md:inline-block text-sm text-gray-300">Panel Admin</span>
            </div>
            <div class="flex items-center gap-3">
                <!-- Mobile menu toggle -->
                <button id="admin-mobile-toggle" class="md:hidden text-gray-300 hover:text-white p-2 rounded" aria-label="Buka menu">
                    <i data-lucide="menu"></i>
                </button>
                <button id="header-admin-back" class="hidden sm:inline-block text-gray-300 hover:text-white px-3 py-2 rounded">Kembali ke situs</button>
                <div class="hidden sm:flex items-center gap-3 mr-2">
                    <img id="header-admin-avatar" src="https://placehold.co/40x40/4B5563/fff?text=AD" alt="avatar" class="w-8 h-8 rounded-full bg-gray-600" />
                    <span id="header-admin-user" class="text-sm text-gray-200"></span>
                </div>
                <button id="header-admin-logout-button" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded">Logout</button>
            </div>
        </nav>
    </header>

    <main id="page-content"> <!-- content rendered by JS --> </main>

    <footer class="bg-gray-800 text-white mt-16">
        <div class="container mx-auto px-6 py-8 text-center">
            <p>&copy; 2025 Jalur QA. Admin panel.</p>
        </div>
    </footer>

    <div id="modal-container"></div>

    <!-- Mobile sidebar overlay -->
    <div id="mobile-sidebar" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden">
        <aside class="w-64 bg-gray-800 text-gray-200 h-full p-4">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-bold">Menu Admin</h3>
                <button id="mobile-sidebar-close" class="text-gray-300 hover:text-white"><i data-lucide="x"></i></button>
            </div>
            <nav id="mobile-admin-nav" class="space-y-2">
                <a class="admin-sidebar-link active" data-admin-page="dashboard">Dashboard</a>
                <a class="admin-sidebar-link" data-admin-page="articles">Artikel</a>
                <a class="admin-sidebar-link" data-admin-page="categories">Kategori</a>
                <a class="admin-sidebar-link" data-admin-page="paths">Jalur Belajar</a>
                <a class="admin-sidebar-link" data-admin-page="tools">Tools (Video)</a>
                <a class="admin-sidebar-link" data-admin-page="comments">Komentar</a>
            </nav>
            <div class="mt-6"><a href="#" id="mobile-logout" class="admin-sidebar-link hover:bg-red-500">Logout</a></div>
        </aside>
    </div>

    <!-- Toast container -->
    <div id="toast-container" class="fixed bottom-6 right-6 z-50"></div>

    <!-- ADMIN TEMPLATES (copied from index.html) -->
    <template id="admin-login-page-template">
        <div class="flex items-center justify-center py-16 bg-gray-100 min-h-screen">
            <div class="w-full max-w-md bg-white p-8 rounded-xl shadow-lg">
                <h2 class="text-3xl font-bold text-center mb-6">Admin Login</h2>
                <form id="admin-login-form">
                    <div class="mb-4">
                        <label for="username" class="block text-gray-700 mb-2">Username</label>
                        <input type="text" id="username" class="w-full px-4 py-2 border rounded-lg" value="anggapubg180@gmail.com" required>
                    </div>
                    <div class="mb-6">
                        <label for="password" class="block text-gray-700 mb-2">Password</label>
                        <input type="password" id="password" class="w-full px-4 py-2 border rounded-lg" value="@ngaT180180" required>
                    </div>
                    <p id="login-error" class="text-red-500 text-sm mb-4 hidden"></p>
                    <button type="submit" class="w-full bg-blue-500 text-white font-bold py-3 px-6 rounded-lg">Login</button>
                </form>
            </div>
        </div>
    </template>

    <template id="admin-panel-page-template">
        <div class="flex min-h-screen bg-gray-100">
            <!-- Sidebar -->
            <aside class="w-64 bg-gray-800 text-gray-200 p-4 hidden md:block">
                <div class="flex flex-col h-full">
                    <h2 class="text-2xl font-bold mb-8 text-white">Admin Panel</h2>
                    <nav id="admin-sidebar-nav" class="space-y-2 flex-grow">
                        <a class="admin-sidebar-link active" data-admin-page="dashboard"><i data-lucide="layout-dashboard" class="mr-3"></i>Dashboard</a>
                        <a class="admin-sidebar-link" data-admin-page="articles"><i data-lucide="file-text" class="mr-3"></i>Artikel</a>
                        <a class="admin-sidebar-link" data-admin-page="categories"><i data-lucide="bookmark" class="mr-3"></i>Kategori</a>
                        <a class="admin-sidebar-link" data-admin-page="paths"><i data-lucide="milestone" class="mr-3"></i>Jalur Belajar</a>
                        <a class="admin-sidebar-link" data-admin-page="tools"><i data-lucide="video" class="mr-3"></i>Tools (Video)</a>
                        <a class="admin-sidebar-link" data-admin-page="comments"><i data-lucide="message-circle" class="mr-3"></i>Komentar</a>
                    </nav>
                </div>
            </aside>
            <!-- Main Content -->
            <main id="admin-content" class="flex-1 p-6 md:p-10">
                <!-- Konten admin akan di-render di sini -->
            </main>
        </div>
    </template>

    <!-- Firebase compat libraries for file:// usage -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <!-- DOMPurify for sanitizing editor HTML (protect public render) -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@2.4.0/dist/purify.min.js"></script>
    <!-- Quill editor (for WYSIWYG) -->
    <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>

    <script type="module">
        // Config (same as index.html)
        const firebaseConfig = {
            apiKey: "AIzaSyC4i7BuTVHx7EaQxyn3Dlv83HTVdtgn9Ik",
            authDomain: "jalur-qa.firebaseapp.com",
            projectId: "jalur-qa",
            storageBucket: "jalur-qa.appspot.com",
            messagingSenderId: "928716547519",
            appId: "1:928716547519:web:10f2e2cd1d84e1f5ca2d0a"
        };

        // Wait for compat library to be available (for file://)
        const waitForFirebase = () => new Promise(resolve => {
            const check = () => { if (window.firebase && window.firebase.firestore) return resolve(); setTimeout(check, 50); };
            check();
        });
        await waitForFirebase();
        firebase.initializeApp(firebaseConfig);
        const firestore = firebase.firestore();
        const auth = firebase.auth();
        console.log('Admin: firebase initialized');

        // Basic app state and cache
        const dbCache = { categories: [], learningPaths: [], tools: [], comments: [] };
        const appState = { isAdmin: false, isLoggedIn: false, currentAdminPage: 'dashboard' };

        const pageContent = document.getElementById('page-content');
        const modalContainer = document.getElementById('modal-container');
    const headerEl = document.querySelector('header');

    const hideHeader = () => { try { if (headerEl) headerEl.style.display = 'none'; } catch (e) { } };
    const showHeader = () => { try { if (headerEl) headerEl.style.display = 'block'; } catch (e) { } };

        // Helpers
        const fetchCollection = async (name) => {
            const snap = await firestore.collection(name).get();
            return snap.docs.map(d => ({ id: d.id, ...d.data() }));
        };

        const isPermissionDenied = (err) => {
            if (!err) return false;
            const code = err.code || '';
            const msg = (err.message || '').toLowerCase();
            return code === 'permission-denied' || msg.includes('missing or insufficient') || msg.includes('permission');
        };

        const showFirestorePermissionModal = (collectionName = '') => {
            const projectId = firebaseConfig && firebaseConfig.projectId ? firebaseConfig.projectId : '<project-id>';
            const suggestedRules = `rules_version = '2';\nservice cloud.firestore {\n  match /databases/{database}/documents {\n    match /${collectionName}/{docId} { allow read, write: if request.auth != null; }\n  }\n}`;
            modalContainer.innerHTML = `
                <div class="modal-overlay">
                    <div class="bg-white rounded-lg p-6 max-w-2xl">
                        <h3 class="text-xl font-bold mb-2">Akses Ditolak oleh Firestore</h3>
                        <p class="text-gray-700">Operasi tulis ditolak oleh aturan keamanan Firestore untuk koleksi <strong>${collectionName || '[semua koleksi terkait]'}</strong>.</p>
                        <pre class="mt-2 p-3 bg-gray-100 rounded text-sm" style="white-space:pre-wrap;">${suggestedRules}</pre>
                        <div class="mt-4 flex justify-end gap-3"><button id="close-perm-modal" class="bg-blue-500 text-white py-2 px-4 rounded">Tutup</button></div>
                    </div>
                </div>`;
            document.getElementById('close-perm-modal').addEventListener('click', () => { modalContainer.innerHTML = ''; });
        };

        const extractYouTubeId = (url) => {
            if (!url) return null; try { const u = url.trim(); const m1 = u.match(/[?&]v=([a-zA-Z0-9_-]{6,})/); if (m1 && m1[1]) return m1[1]; const m2 = u.match(/youtu\.be\/([a-zA-Z0-9_-]{6,})/); if (m2 && m2[1]) return m2[1]; const m3 = u.match(/embed\/([a-zA-Z0-9_-]{6,})/); if (m3 && m3[1]) return m3[1]; return null; } catch (e) { return null; }
        };
        const isYouTubeUrl = (url) => !!extractYouTubeId(url);

        const getCategoryName = (id) => dbCache.categories.find(c => c.id === id)?.name || 'Tanpa Kategori';

        // --- ADMIN MODALS & HANDLERS (copied/adapted) ---
        const showArticleModal = async (articleId = null) => {
            const isEditing = articleId !== null; let article = {};
            if (isEditing) { const doc = await firestore.collection('articles').doc(articleId).get(); if (doc.exists) article = { id: doc.id, ...doc.data() }; }
            const modalTitle = isEditing ? 'Edit Artikel' : 'Tambah Artikel Baru';
            const categoryOptions = dbCache.categories.map(c => `<option value="${c.id}" ${article.categoryId === c.id ? 'selected' : ''}>${c.name}</option>`).join('');
            modalContainer.innerHTML = `
            <div class="modal-overlay">
                <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                    <div class="p-6 border-b flex justify-between items-center sticky top-0 bg-white z-10">
                        <h3 class="text-2xl font-bold">${modalTitle}</h3>
                        <button id="close-modal-btn" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
                    </div>
                    <form id="article-form" class="p-6 space-y-4">
                                <input type="hidden" name="id" value="${article.id || ''}">
                                <div><label class="block text-sm font-medium">Judul</label><input type="text" name="title" class="mt-1 w-full border-gray-300 rounded-md shadow-sm" value="${article.title || ''}" required></div>
                                <div><label class="block text-sm font-medium">Kategori</label><select name="categoryId" class="mt-1 w-full border-gray-300 rounded-md shadow-sm bg-white" required>${categoryOptions}</select></div>
                                <div>
                                    <label class="block text-sm font-medium">URL Gambar (opsional)</label>
                                    <input type="text" name="image" class="mt-1 w-full border-gray-300 rounded-md shadow-sm" value="${article.image || ''}">
                                </div>
                                <div><label class="block text-sm font-medium">Kutipan</label><textarea name="excerpt" rows="3" class="mt-1 w-full border-gray-300 rounded-md shadow-sm" required>${article.excerpt || ''}</textarea></div>
                                <div>
                                    <label class="block text-sm font-medium">Konten</label>
                                    <div class="mt-1 border rounded-md bg-white shadow-sm">
                                        <div id="quill-toolbar">
                                            <!-- Quill toolbar will be injected -->
                                        </div>
                                        <div id="quill-editor" class="bg-white" style="min-height:200px; max-height:50vh; overflow-y:auto">${article.content ? article.content.trim() : ''}</div>
                                        <textarea name="content" id="hidden-article-content" class="hidden">${article.content ? article.content.trim() : ''}</textarea>
                                        <div class="mt-2 flex gap-2"><button type="button" id="preview-article-btn" class="bg-gray-200 px-3 py-1 rounded">Preview</button></div>
                                    </div>
                                </div>
                                <div class="pt-4 flex justify-end gap-3"><button type="button" id="cancel-modal-btn" class="bg-gray-200 py-2 px-4 rounded-lg">Batal</button><button type="submit" class="bg-blue-500 text-white py-2 px-4 rounded-lg">Simpan</button></div>
                            </form>
                </div>
            </div>`;
                // attach submit handler immediately so native form submission is prevented even if Quill fails to initialize
                (function attachArticleFormHandler(){
                    const _articleForm = document.getElementById('article-form');
                    if (!_articleForm) return;
                    if (_articleForm.dataset.handlerAttached) return;
                    // set method to POST to avoid default GET query-string navigation
                    try { _articleForm.method = 'post'; } catch(e){}
                    _articleForm.onsubmit = async function(ev) {
                        try {
                            console.log('Article form onsubmit wrapper invoked');
                            ev.preventDefault();
                            const hiddenContent = document.getElementById('hidden-article-content');
                            if (hiddenContent && window.adminQuill) hiddenContent.value = window.adminQuill.root.innerHTML;
                            await handleArticleFormSubmit(ev);
                        } catch (e) { console.error('Article form submit wrapper failed:', e); }
                        return false;
                    };
                    _articleForm.dataset.handlerAttached = '1';
                })();
            // Initialize Quill
            let quill;
            try {
                const quillToolbarOptions = [[{'header':[1,2,3,false]}], ['bold','italic','underline','strike'], [{'list':'ordered'},{'list':'bullet'}], ['link','image'], [{ 'font': [] }], [{ 'align': [] }], ['clean']];
                const toolbarContainer = document.getElementById('quill-toolbar');
                toolbarContainer.innerHTML = `<div id="quill-toolbar-inner"></div>`;
                quill = new Quill('#quill-editor', { modules: { toolbar: quillToolbarOptions }, theme: 'snow' });
                // load initial content if any
                const hiddenContent = document.getElementById('hidden-article-content');
                if (hiddenContent && hiddenContent.value) quill.root.innerHTML = hiddenContent.value;
                // expose quill instance globally to ensure submit handler can read it
                window.adminQuill = quill;
                console.log('Quill initialized for article modal. adminQuill=', window.adminQuill, 'hiddenContent exists=', !!hiddenContent);
                // (submit handling is attached outside so it works even if Quill init fails)
                // preview
                const previewBtn = document.getElementById('preview-article-btn');
                if (previewBtn) previewBtn.addEventListener('click', () => {
                    const raw = (window.adminQuill && window.adminQuill.root) ? window.adminQuill.root.innerHTML : quill.root.innerHTML;
                    const sanitized = (window.DOMPurify && typeof DOMPurify.sanitize === 'function') ? DOMPurify.sanitize(raw) : raw;
                    // append overlay so form remains underneath
                    const overlay = document.createElement('div'); overlay.className = 'modal-overlay'; overlay.id = 'article-preview-overlay';
                    overlay.innerHTML = `<div class="bg-white rounded-lg p-6 max-w-3xl max-h-[80vh] overflow-y-auto"><h3 class="text-lg font-bold mb-4">Preview Artikel</h3><div class="prose max-w-none">${sanitized}</div><div class="mt-4 text-right"><button id="close-preview" class="bg-gray-200 px-3 py-1 rounded">Tutup</button></div></div>`;
                    modalContainer.appendChild(overlay);
                    const close = document.getElementById('close-preview'); if (close) close.addEventListener('click', (ev) => { ev.preventDefault(); const el = document.getElementById('article-preview-overlay'); if (el) el.remove(); });
                });
            } catch (e) { console.warn('Quill init failed, falling back to contentEditable', e); }
            document.getElementById('close-modal-btn').addEventListener('click', () => modalContainer.innerHTML = '');
            document.getElementById('cancel-modal-btn').addEventListener('click', () => modalContainer.innerHTML = '');
            document.getElementById('close-modal-btn').addEventListener('click', () => modalContainer.innerHTML = '');
            document.getElementById('cancel-modal-btn').addEventListener('click', () => modalContainer.innerHTML = '');
        };

        const handleArticleFormSubmit = async (e) => {
            e.preventDefault();
            const form = new FormData(e.target);
            const articleId = form.get('id');
            const submitBtn = (e.target.querySelector && e.target.querySelector('button[type="submit"]')) || null;
            try {
                console.log('Article submit started. articleId=', articleId);
                console.log('Current auth user:', auth && auth.currentUser ? { uid: auth.currentUser.uid, email: auth.currentUser.email } : null);
                // prefer Quill's live content if available
                let rawContent = '';
                if (window.adminQuill && window.adminQuill.root) rawContent = window.adminQuill.root.innerHTML;
                else rawContent = form.get('content') || '';
                const safeContent = (window.DOMPurify && typeof DOMPurify.sanitize === 'function') ? DOMPurify.sanitize(rawContent) : rawContent;
                const articleData = {
                    title: form.get('title'),
                    categoryId: form.get('categoryId'),
                    image: form.get('image'),
                    excerpt: form.get('excerpt'),
                    content: safeContent,
                    author: 'Admin',
                    authorId: (auth && auth.currentUser && auth.currentUser.uid) ? auth.currentUser.uid : null,
                    slug: (form.get('title') || '').toString().toLowerCase().replace(/\s+/g, '-').replace(/[^\w-]+/g, ''),
                };
                console.log('Article data prepared:', articleData);
                if (submitBtn) { submitBtn.disabled = true; submitBtn.textContent = 'Menyimpan...'; }
                let writeResult = null;
                if (!articleId) {
                    articleData.date = firebase.firestore.Timestamp.now();
                    writeResult = await firestore.collection('articles').add(articleData);
                    console.log('Article added, ref id=', writeResult && writeResult.id);
                } else {
                    await firestore.collection('articles').doc(articleId).update(articleData);
                    writeResult = { id: articleId };
                    console.log('Article updated, id=', articleId);
                }
                showToast('Artikel berhasil disimpan', 'info');
                modalContainer.innerHTML = '';
                await renderAdminPanel('articles');
            } catch (err) {
                console.error('Gagal menyimpan artikel:', err);
                if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = 'Simpan'; }
                if (isPermissionDenied(err)) showFirestorePermissionModal('articles');
                else {
                    // show detailed modal with error info
                    modalContainer.innerHTML = `<div class="modal-overlay"><div class="bg-white rounded-lg p-6 max-w-md"><h3 class="text-lg font-bold mb-2">Gagal Menyimpan</h3><pre style="white-space:pre-wrap;">${err && err.message ? err.message : JSON.stringify(err)}</pre><div class="mt-4"><button id="close-save-error" class="bg-gray-200 py-2 px-4 rounded">Tutup</button></div></div></div>`;
                    document.getElementById('close-save-error').addEventListener('click', () => modalContainer.innerHTML = '');
                }
            }
        };

        const showCategoryModal = (categoryId = null) => {
            const category = categoryId ? dbCache.categories.find(c => c.id === categoryId) : {}; const modalTitle = categoryId ? 'Edit Kategori' : 'Tambah Kategori Baru';
            modalContainer.innerHTML = `
            <div class="modal-overlay">
                <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
                    <div class="p-6 border-b flex justify-between items-center"><h3 class="text-2xl font-bold">${modalTitle}</h3><button id="close-modal-btn" class="text-3xl">&times;</button></div>
                    <form id="category-form" class="p-6 space-y-4">
                        <input type="hidden" name="id" value="${category.id || ''}">
                        <div><label class="block text-sm font-medium">Nama Kategori</label><input type="text" name="name" class="mt-1 w-full border-gray-300 rounded-md shadow-sm" value="${category.name || ''}" required></div>
                        <div class="pt-4 flex justify-end gap-3"><button type="button" id="cancel-modal-btn" class="bg-gray-200 py-2 px-4 rounded-lg">Batal</button><button type="submit" class="bg-blue-500 text-white py-2 px-4 rounded-lg">Simpan</button></div>
                    </form>
                </div>
            </div>`;
            document.getElementById('category-form').addEventListener('submit', handleCategoryFormSubmit);
            document.getElementById('close-modal-btn').addEventListener('click', () => modalContainer.innerHTML = '');
            document.getElementById('cancel-modal-btn').addEventListener('click', () => modalContainer.innerHTML = '');
        };

        const handleCategoryFormSubmit = async (e) => {
            e.preventDefault(); const form = new FormData(e.target); const id = form.get('id'); const data = { name: form.get('name') };
            try { if (!id) { await firestore.collection('categories').add(data); } else { await firestore.collection('categories').doc(id).update(data); } dbCache.categories = await fetchCollection('categories'); modalContainer.innerHTML = `<div class="modal-overlay"><div class="bg-white rounded-lg p-6 max-w-md text-center"><h3 class="text-lg font-bold mb-2">Berhasil</h3><p>Kategori berhasil disimpan.</p><div class="mt-4"><button id="close-save-success" class="bg-blue-500 text-white py-2 px-4 rounded">Tutup</button></div></div></div>`; document.getElementById('close-save-success').addEventListener('click', () => { modalContainer.innerHTML = ''; renderAdminPanel('categories'); }); } catch (err) { console.error('Gagal menyimpan kategori:', err); if (isPermissionDenied(err)) showFirestorePermissionModal('categories'); else { modalContainer.innerHTML = `<div class="modal-overlay"><div class="bg-white rounded-lg p-6 max-w-md"><h3 class="text-lg font-bold mb-2">Gagal Menyimpan</h3><pre style="white-space:pre-wrap;">${err && err.message ? err.message : JSON.stringify(err)}</pre><div class="mt-4"><button id="close-save-error" class="bg-gray-200 py-2 px-4 rounded">Tutup</button></div></div></div>`; document.getElementById('close-save-error').addEventListener('click', () => modalContainer.innerHTML = ''); } }
        };

        // Tools modal
        const showToolModal = async (toolId = null) => {
            const isEditing = toolId !== null; let tool = {};
            if (isEditing) { const doc = await firestore.collection('tools').doc(toolId).get(); if (doc.exists) tool = { id: doc.id, ...doc.data() }; }
            const modalTitle = isEditing ? 'Edit Tool (Video)' : 'Tambah Tool (Video)';
            modalContainer.innerHTML = `
            <div class="modal-overlay">
                <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                    <div class="p-6 border-b flex justify-between items-center sticky top-0 bg-white z-10">
                        <h3 class="text-2xl font-bold">${modalTitle}</h3>
                        <button id="close-modal-btn" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
                    </div>
                    <form id="tool-form" class="p-6 space-y-4">
                        <input type="hidden" name="id" value="${tool.id || ''}">
                        <div><label class="block text-sm font-medium">Judul</label><input type="text" name="title" class="mt-1 w-full border-gray-300 rounded-md shadow-sm" value="${tool.title || ''}" required></div>
                        <div><label class="block text-sm font-medium">Deskripsi Singkat</label><textarea name="description" rows="3" class="mt-1 w-full border-gray-300 rounded-md shadow-sm">${tool.description || ''}</textarea></div>
                        <div>
                            <label class="block text-sm font-medium">Video YouTube</label>
                            <div id="video-rows" class="space-y-2 mt-2"></div>
                            <div class="mt-2"><button type="button" id="add-video-row" class="bg-green-500 text-white px-3 py-1 rounded">Tambah URL Video</button></div>
                            <p class="text-xs text-gray-500 mt-2">Satu URL per input.</p>
                        </div>
                        <div class="pt-4 flex justify-end gap-3"><button type="button" id="cancel-modal-btn" class="bg-gray-200 py-2 px-4 rounded-lg">Batal</button><button type="submit" class="bg-blue-500 text-white py-2 px-4 rounded-lg">Simpan</button></div>
                    </form>
                </div>
            </div>`;
            const rowsContainer = document.getElementById('video-rows');
            const addRow = (value = '') => {
                const wrapper = document.createElement('div'); wrapper.className = 'space-y-1';
                const inputId = 'video-input-' + (Date.now() + Math.floor(Math.random()*1000));
                wrapper.innerHTML = `
                    <div class="flex items-start gap-2">
                        <input id="${inputId}" type="text" name="video-url" value="${value}" placeholder="https://www.youtube.com/watch?v=..." class="flex-1 border rounded px-3 py-2" />
                        <img class="video-thumb w-28 h-16 rounded object-cover border" src="https://placehold.co/120x90/E2E8F0/333?text=Preview" style="display:none" />
                        <button type="button" class="remove-video-row bg-red-500 text-white px-2 py-1 rounded">Hapus</button>
                    </div>
                    <div class="flex items-center gap-2"><span class="text-red-500 text-xs hidden error-msg">URL YouTube tidak valid</span></div>
                `;
                rowsContainer.appendChild(wrapper);
                const input = wrapper.querySelector('input[name="video-url"]'); const thumb = wrapper.querySelector('.video-thumb'); const errorMsg = wrapper.querySelector('.error-msg');
                const updatePreview = () => { const v = input.value.trim(); const id = extractYouTubeId(v); if (id) { thumb.src = `https://img.youtube.com/vi/${id}/hqdefault.jpg`; thumb.style.display = 'block'; errorMsg.classList.add('hidden'); input.classList.remove('border-red-500'); } else if (v === '') { thumb.style.display = 'none'; errorMsg.classList.add('hidden'); input.classList.remove('border-red-500'); } else { thumb.style.display = 'none'; errorMsg.classList.remove('hidden'); input.classList.add('border-red-500'); } };
                input.addEventListener('input', updatePreview); updatePreview(); wrapper.querySelector('.remove-video-row').addEventListener('click', () => wrapper.remove());
            };
            if (tool.videos && Array.isArray(tool.videos) && tool.videos.length > 0) tool.videos.forEach(v => addRow(v)); else addRow('');
            document.getElementById('add-video-row').addEventListener('click', () => addRow(''));
            document.getElementById('tool-form').addEventListener('submit', handleToolFormSubmit);
            document.getElementById('close-modal-btn').addEventListener('click', () => modalContainer.innerHTML = '');
            document.getElementById('cancel-modal-btn').addEventListener('click', () => modalContainer.innerHTML = '');
        };

        const handleToolFormSubmit = async (e) => {
            e.preventDefault(); const form = new FormData(e.target); const id = form.get('id'); const title = form.get('title'); const description = form.get('description'); const videoInputs = Array.from(e.target.querySelectorAll('input[name="video-url"]')); const videos = videoInputs.map(i => i.value.trim()).filter(Boolean); const invalid = videoInputs.some(i => i.value.trim() !== '' && !isYouTubeUrl(i.value.trim())); if (invalid) { modalContainer.innerHTML = `<div class="modal-overlay"><div class="bg-white rounded-lg p-6 max-w-md text-center"><h3 class="text-lg font-bold mb-2">URL Tidak Valid</h3><p>Beberapa URL bukan berasal dari YouTube. Periksa kembali input URL video.</p><div class="mt-4"><button id="close-invalid-video" class="bg-blue-500 text-white py-2 px-4 rounded">Tutup</button></div></div></div>`; document.getElementById('close-invalid-video').addEventListener('click', () => modalContainer.innerHTML = ''); return; }
            const data = { title, description, videos };
            try { if (!id) await firestore.collection('tools').add(data); else await firestore.collection('tools').doc(id).update(data); dbCache.tools = await fetchCollection('tools'); modalContainer.innerHTML = ''; await renderAdminPanel('tools'); } catch (err) { console.error('Gagal menyimpan tool:', err); if (isPermissionDenied(err)) showFirestorePermissionModal('tools'); else { modalContainer.innerHTML = `<div class="modal-overlay"><div class="bg-white rounded-lg p-6 max-w-md"><h3 class="text-lg font-bold mb-2">Gagal Menyimpan</h3><pre style="white-space:pre-wrap;">${err && err.message ? err.message : JSON.stringify(err)}</pre><div class="mt-4"><button id="close-save-error" class="bg-gray-200 py-2 px-4 rounded">Tutup</button></div></div></div>`; document.getElementById('close-save-error').addEventListener('click', () => modalContainer.innerHTML = ''); } }
        };

        const showPathModal = async (pathId = null) => {
            const isEditing = pathId !== null;
            let path = {};
            if (isEditing) {
                const doc = await firestore.collection('learningPaths').doc(pathId).get();
                if (doc.exists) path = { id: doc.id, ...doc.data() };
            }
            // fetch available articles to populate selects
            let allArticles = [];
            try { allArticles = await fetchCollection('articles'); } catch (e) { console.error('Failed to load articles for path modal', e); }
            const modalTitle = isEditing ? 'Edit Jalur Belajar' : 'Tambah Jalur Belajar';
            modalContainer.innerHTML = `
            <div class="modal-overlay">
                <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                    <div class="p-6 border-b flex justify-between items-center sticky top-0 bg-white z-10"><h3 class="text-2xl font-bold">${modalTitle}</h3><button id="close-modal-btn" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button></div>
                    <form id="path-form" class="p-6 space-y-4">
                        <input type="hidden" name="id" value="${path.id || ''}">
                        <div><label class="block text-sm font-medium">Judul</label><input type="text" name="title" class="mt-1 w-full border-gray-300 rounded-md shadow-sm" value="${path.title || ''}" required></div>
                        <div><label class="block text-sm font-medium">Deskripsi Singkat</label><textarea name="description" rows="3" class="mt-1 w-full border-gray-300 rounded-md shadow-sm" required>${path.description || ''}</textarea></div>
                        <div><label class="block text-sm font-medium">URL Gambar</label><input type="text" name="image" class="mt-1 w-full border-gray-300 rounded-md shadow-sm" value="${path.image || ''}"></div>
                        <div>
                            <label class="block text-sm font-medium">Artikel</label>
                            <div id="article-rows" class="space-y-2 mt-2"></div>
                            <div class="mt-2"><button type="button" id="add-article-row" class="bg-green-500 text-white px-3 py-1 rounded">Tambah Artikel</button></div>
                            <p class="text-xs text-gray-500 mt-2">Pilih artikel yang termasuk dalam jalur ini. Urutan akan disimpan sesuai baris.</p>
                        </div>
                        <div class="pt-4 flex justify-end gap-3"><button type="button" id="cancel-modal-btn" class="bg-gray-200 py-2 px-4 rounded-lg">Batal</button><button type="submit" class="bg-blue-500 text-white py-2 px-4 rounded-lg">Simpan</button></div>
                    </form>
                </div>
            </div>`;

            const rowsContainer = document.getElementById('article-rows');
            const buildOptions = (selectedId = '') => {
                const opts = allArticles.map(a => `<option value="${a.id}" ${a.id===selectedId ? 'selected' : ''}>${(a.title||a.id).replace(/"/g,'')}</option>`).join('');
                return `<option value="">-- Pilih Artikel --</option>${opts}`;
            };

            const addRow = (selectedId = '') => {
                const wrapper = document.createElement('div'); wrapper.className = 'flex items-center gap-2';
                const selectId = 'path-article-' + (Date.now() + Math.floor(Math.random()*1000));
                wrapper.innerHTML = `
                    <select id="${selectId}" name="article-id" class="flex-1 border rounded px-3 py-2 bg-white">${buildOptions(selectedId)}</select>
                    <button type="button" class="remove-article-row bg-red-500 text-white px-2 py-1 rounded">Hapus</button>
                `;
                rowsContainer.appendChild(wrapper);
                wrapper.querySelector('.remove-article-row').addEventListener('click', () => wrapper.remove());
            };

            // initialize rows from existing path data or provide one empty row
            const initialArticles = Array.isArray(path.articles) ? path.articles : [];
            if (initialArticles.length > 0) initialArticles.forEach(aid => addRow(aid)); else addRow('');

            document.getElementById('add-article-row').addEventListener('click', () => addRow(''));
            document.getElementById('path-form').addEventListener('submit', handlePathFormSubmit);
            document.getElementById('close-modal-btn').addEventListener('click', () => modalContainer.innerHTML = '');
            document.getElementById('cancel-modal-btn').addEventListener('click', () => modalContainer.innerHTML = '');
        };

        const handlePathFormSubmit = async (e) => {
            e.preventDefault();
            const form = new FormData(e.target);
            const id = form.get('id');
            // collect article ids from selects named 'article-id'
            const selects = Array.from(e.target.querySelectorAll('select[name="article-id"]'));
            const articles = selects.map(s => s.value).filter(Boolean);
            const data = {
                title: form.get('title'),
                description: form.get('description'),
                image: form.get('image') || 'https://placehold.co/600x400',
                articles
            };
            try {
                if (!id) await firestore.collection('learningPaths').add(data);
                else await firestore.collection('learningPaths').doc(id).update(data);
                dbCache.learningPaths = await fetchCollection('learningPaths');
                modalContainer.innerHTML = '';
                await renderAdminPanel('paths');
            } catch (err) {
                console.error('Gagal menyimpan jalur belajar:', err);
                if (isPermissionDenied(err)) showFirestorePermissionModal('learningPaths');
                else {
                    modalContainer.innerHTML = `<div class="modal-overlay"><div class="bg-white rounded-lg p-6 max-w-md"><h3 class="text-lg font-bold mb-2">Gagal Menyimpan</h3><pre style="white-space:pre-wrap;">${err && err.message ? err.message : JSON.stringify(err)}</pre><div class="mt-4"><button id="close-save-error" class="bg-gray-200 py-2 px-4 rounded">Tutup</button></div></div></div>`;
                    document.getElementById('close-save-error').addEventListener('click', () => modalContainer.innerHTML = '');
                }
            }
        };

        const showCommentModal = (commentId = null) => {
            const comment = commentId ? dbCache.comments.find(c => c.id === commentId) : {};
            modalContainer.innerHTML = `
            <div class="modal-overlay">
                <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                    <div class="p-6 border-b flex justify-between items-center sticky top-0 bg-white z-10"><h3 class="text-2xl font-bold">Balas Komentar</h3><button id="close-modal-btn" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button></div>
                    <form id="comment-reply-form" class="p-6 space-y-4">
                        <input type="hidden" name="id" value="${comment.id || ''}">
                        <div><label class="block text-sm font-medium">Nama</label><input type="text" name="name" class="mt-1 w-full border-gray-300 rounded-md shadow-sm" value="${comment.name || ''}" disabled></div>
                        <div><label class="block text-sm font-medium">Komentar</label><textarea rows="4" class="mt-1 w-full border-gray-300 rounded-md shadow-sm" disabled>${comment.text || ''}</textarea></div>
                        <div><label class="block text-sm font-medium">Balasan</label><textarea name="reply" rows="4" class="mt-1 w-full border-gray-300 rounded-md shadow-sm">${comment.reply || ''}</textarea></div>
                        <div class="pt-4 flex justify-end gap-3"><button type="button" id="cancel-modal-btn" class="bg-gray-200 py-2 px-4 rounded-lg">Batal</button><button type="submit" class="bg-blue-500 text-white py-2 px-4 rounded-lg">Simpan Balasan & Approve</button></div>
                    </form>
                </div>
            </div>`;
            document.getElementById('close-modal-btn').addEventListener('click', () => modalContainer.innerHTML = '');
            document.getElementById('cancel-modal-btn').addEventListener('click', () => modalContainer.innerHTML = '');
            document.getElementById('comment-reply-form').addEventListener('submit', async (e) => {
                e.preventDefault(); const form = new FormData(e.target); const id = form.get('id'); const reply = form.get('reply'); try { await firestore.collection('comments').doc(id).update({ reply, approved: true }); dbCache.comments = await fetchCollection('comments'); modalContainer.innerHTML = ''; await renderAdminPanel('comments'); } catch (err) { console.error('Gagal membalas komentar:', err); if (isPermissionDenied(err)) showFirestorePermissionModal('comments'); else { modalContainer.innerHTML = `<div class="modal-overlay"><div class="bg-white rounded-lg p-6 max-w-md"><h3 class="text-lg font-bold mb-2">Gagal Menyimpan Balasan</h3><pre style="white-space:pre-wrap;">${err && err.message ? err.message : JSON.stringify(err)}</pre><div class="mt-4"><button id="close-save-error" class="bg-gray-200 py-2 px-4 rounded">Tutup</button></div></div></div>`; } } });
        };

        const showDeleteConfirmation = async (type, id) => {
            let item; let collectionName;
            if (type === 'article') { const doc = await firestore.collection('articles').doc(id).get(); if (doc.exists) item = doc.data(); collectionName = 'articles'; }
            else if (type === 'category') { item = dbCache.categories.find(c => c.id === id); collectionName = 'categories'; }
            else if (type === 'path') { const doc = await firestore.collection('learningPaths').doc(id).get(); if (doc.exists) item = doc.data(); collectionName = 'learningPaths'; }
            else if (type === 'comment') { const doc = await firestore.collection('comments').doc(id).get(); if (doc.exists) item = doc.data(); collectionName = 'comments'; }
            else if (type === 'tool') { const doc = await firestore.collection('tools').doc(id).get(); if (doc.exists) item = doc.data(); collectionName = 'tools'; }
            if (!item) return; const itemName = item.title || item.name;
            modalContainer.innerHTML = `
            <div class="modal-overlay">
                <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
                    <h3 class="text-xl font-bold mb-4">Konfirmasi Hapus</h3>
                    <p>Apakah Anda yakin ingin menghapus "${itemName}"?</p>
                    <div class="mt-6 flex justify-end gap-3"><button id="cancel-delete-btn" class="bg-gray-200 py-2 px-4 rounded-lg">Batal</button><button id="confirm-delete-btn" class="bg-red-500 text-white py-2 px-4 rounded-lg" data-id="${id}" data-collection="${collectionName}">Hapus</button></div>
                </div>
            </div>`;
            document.getElementById('cancel-delete-btn').addEventListener('click', () => modalContainer.innerHTML = '');
            document.getElementById('confirm-delete-btn').addEventListener('click', async (e) => {
                const idToDelete = e.target.dataset.id; const collectionToDelete = e.target.dataset.collection; try { await firestore.collection(collectionToDelete).doc(idToDelete).delete(); } catch (err) { console.error('Gagal menghapus:', err); if (isPermissionDenied(err)) showFirestorePermissionModal(collectionToDelete); modalContainer.innerHTML = ''; return; }
                if (collectionToDelete === 'categories') dbCache.categories = await fetchCollection('categories');
                if (collectionToDelete === 'learningPaths') dbCache.learningPaths = await fetchCollection('learningPaths');
                if (collectionToDelete === 'comments') dbCache.comments = await fetchCollection('comments');
                if (collectionToDelete === 'tools') dbCache.tools = await fetchCollection('tools');
                modalContainer.innerHTML = '';
                if (collectionToDelete === 'categories') await renderAdminPanel('categories'); else if (collectionToDelete === 'learningPaths') await renderAdminPanel('paths'); else if (collectionToDelete === 'comments') await renderAdminPanel('comments'); else if (collectionToDelete === 'articles') await renderAdminPanel('articles'); else await renderAdminPanel('dashboard');
            });
        };

        // Render admin panel pages
        const renderAdminPanel = async (adminPage = 'dashboard') => {
            if (!appState.isLoggedIn || !appState.isAdmin) { modalContainer.innerHTML = `<div class="modal-overlay"><div class="bg-white rounded-lg p-6 max-w-md text-center"><h3 class="text-lg font-bold mb-2">Akses Ditolak</h3><p>Halaman admin hanya dapat diakses oleh akun admin.</p><div class="mt-4"><button id="close-access-denied" class="bg-gray-200 py-2 px-4 rounded">Tutup</button></div></div></div>`; document.getElementById('close-access-denied').addEventListener('click', () => { modalContainer.innerHTML = ''; window.location.href = 'index.html'; }); return; }
            // show header for admin pages
            showHeader();
            appState.currentAdminPage = adminPage; pageContent.innerHTML = document.getElementById('admin-panel-page-template').innerHTML; const adminContent = document.getElementById('admin-content');
            document.querySelectorAll('.admin-sidebar-link').forEach(link => { link.classList.toggle('active', link.dataset.adminPage === adminPage); });
            if (!appState.isAdmin) { document.querySelectorAll('.admin-sidebar-link').forEach(link => { if (['categories','paths','comments'].includes(link.dataset.adminPage)) link.style.display = 'none'; }); }
            if (adminPage === 'dashboard') { const articles = await fetchCollection('articles'); adminContent.innerHTML = `<h1 class="text-3xl font-bold mb-6">Dashboard</h1><div class="grid md:grid-cols-3 gap-6"><div class="bg-white p-6 rounded-lg shadow"><h3 class="text-lg font-semibold text-gray-500">Total Artikel</h3><p class="text-4xl font-bold">${articles.length}</p></div><div class="bg-white p-6 rounded-lg shadow"><h3 class="text-lg font-semibold text-gray-500">Total Kategori</h3><p class="text-4xl font-bold">${dbCache.categories.length}</p></div></div>`; }
            else if (adminPage === 'articles') { const articles = await fetchCollection('articles'); adminContent.innerHTML = `<div class="flex justify-between items-center mb-6"><h1 class="text-3xl font-bold">Manajemen Artikel</h1><button id="add-article-btn" class="bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg flex items-center gap-2"><i data-lucide="plus-circle" class="w-5 h-5"></i><span>Tambah Artikel</span></button></div><div class="bg-white p-6 rounded-lg shadow overflow-x-auto"><table class="w-full text-left"><thead><tr class="border-b"><th class="p-4">Judul</th><th class="p-4">Kategori</th><th class="p-4">Tanggal</th><th class="p-4">Aksi</th></tr></thead><tbody>${articles.map(a => { const date = (a.date && typeof a.date.toDate === 'function') ? a.date.toDate() : new Date(a.date); return `<tr class="border-b hover:bg-gray-50"><td class="p-4">${a.title}</td><td class="p-4">${getCategoryName(a.categoryId)}</td><td class="p-4">${date.toLocaleDateString('id-ID')}</td><td class="p-4 flex gap-2"><button class="edit-article-btn text-blue-500" data-id="${a.id}"><i data-lucide="edit"></i></button><button class="delete-article-btn text-red-500" data-id="${a.id}"><i data-lucide="trash-2"></i></button></td></tr>` }).join('')}</tbody></table></div>`; const addArticleBtn = document.getElementById('add-article-btn'); if (addArticleBtn) addArticleBtn.addEventListener('click', () => showArticleModal()); }
            else if (adminPage === 'categories') { adminContent.innerHTML = `<div class="flex justify-between items-center mb-6"><h1 class="text-3xl font-bold">Manajemen Kategori</h1><button id="add-category-btn" class="bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg flex items-center gap-2"><i data-lucide="plus-circle" class="w-5 h-5"></i><span>Tambah Kategori</span></button></div><div class="bg-white p-6 rounded-lg shadow overflow-x-auto"><table class="w-full text-left"><thead><tr class="border-b"><th class="p-4">ID</th><th class="p-4">Nama Kategori</th><th class="p-4">Aksi</th></tr></thead><tbody>${dbCache.categories.map(c => `<tr class="border-b hover:bg-gray-50"><td class="p-4">${c.id}</td><td class="p-4">${c.name}</td><td class="p-4 flex gap-2"><button class="edit-category-btn text-blue-500" data-id="${c.id}"><i data-lucide="edit"></i></button><button class="delete-category-btn text-red-500" data-id="${c.id}"><i data-lucide="trash-2"></i></button></td></tr>`).join('')}</tbody></table></div>`; const addCatBtn = document.getElementById('add-category-btn'); if (addCatBtn) addCatBtn.addEventListener('click', () => showCategoryModal()); }
            else if (adminPage === 'paths') { const paths = await fetchCollection('learningPaths'); adminContent.innerHTML = `<div class="flex justify-between items-center mb-6"><h1 class="text-3xl font-bold">Manajemen Jalur Belajar</h1><button id="add-path-btn" class="bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg flex items-center gap-2"><i data-lucide="plus-circle" class="w-5 h-5"></i><span>Tambah Jalur</span></button></div><div class="bg-white p-6 rounded-lg shadow overflow-x-auto"><table class="w-full text-left"><thead><tr class="border-b"><th class="p-4">Judul</th><th class="p-4">Deskripsi</th><th class="p-4">Jumlah Artikel</th><th class="p-4">Aksi</th></tr></thead><tbody>${paths.map(p => `<tr class="border-b hover:bg-gray-50"><td class="p-4">${p.title}</td><td class="p-4">${p.description}</td><td class="p-4">${(p.articles||[]).length}</td><td class="p-4 flex gap-2"><button class="edit-path-btn text-blue-500" data-id="${p.id}"><i data-lucide="edit"></i></button><button class="delete-path-btn text-red-500" data-id="${p.id}"><i data-lucide="trash-2"></i></button></td></tr>`).join('')}</tbody></table></div>`; const addPathBtn = document.getElementById('add-path-btn'); if (addPathBtn) addPathBtn.addEventListener('click', () => showPathModal()); }
            else if (adminPage === 'comments') { const comments = await fetchCollection('comments'); adminContent.innerHTML = `<h1 class="text-3xl font-bold mb-6">Manajemen Komentar</h1><div class="bg-white p-6 rounded-lg shadow overflow-x-auto"><table class="w-full text-left"><thead><tr class="border-b"><th class="p-4">Nama</th><th class="p-4">Komentar</th><th class="p-4">Status</th><th class="p-4">Aksi</th></tr></thead><tbody>${comments.map(c => `<tr class="border-b hover:bg-gray-50"><td class="p-4">${c.name}</td><td class="p-4">${c.text}</td><td class="p-4">${c.approved ? '<span class="text-green-600 font-semibold">Approved</span>' : '<span class="text-yellow-600 font-semibold">Pending</span>'}</td><td class="p-4 flex gap-2"><button class="reply-comment-btn text-blue-500" data-id="${c.id}"><i data-lucide="message-square"></i></button><button class="approve-comment-btn text-green-500" data-id="${c.id}"><i data-lucide="check-circle"></i></button><button class="delete-comment-btn text-red-500" data-id="${c.id}"><i data-lucide="trash-2"></i></button></td></tr>`).join('')}</tbody></table></div>`; }
            else if (adminPage === 'tools') { const tools = await fetchCollection('tools'); adminContent.innerHTML = `<div class="flex justify-between items-center mb-6"><h1 class="text-3xl font-bold">Manajemen Tools (Video)</h1><button id="add-tool-btn" class="bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg flex items-center gap-2"><i data-lucide="plus-circle" class="w-5 h-5"></i><span>Tambah Tool</span></button></div><div class="bg-white p-6 rounded-lg shadow overflow-x-auto"><table class="w-full text-left"><thead><tr class="border-b"><th class="p-4">Judul</th><th class="p-4">Deskripsi</th><th class="p-4"># Video</th><th class="p-4">Aksi</th></tr></thead><tbody>${tools.map(t => `<tr class="border-b hover:bg-gray-50"><td class="p-4">${t.title}</td><td class="p-4">${t.description || ''}</td><td class="p-4">${(t.videos||[]).length}</td><td class="p-4 flex gap-2"><button class="edit-tool-btn text-blue-500" data-id="${t.id}"><i data-lucide="edit"></i></button><button class="delete-tool-btn text-red-500" data-id="${t.id}"><i data-lucide="trash-2"></i></button></td></tr>`).join('')}</tbody></table></div>`; const addToolBtn = document.getElementById('add-tool-btn'); if (addToolBtn) addToolBtn.addEventListener('click', () => showToolModal()); }
            lucide.createIcons();
            // ensure header buttons are wired after rendering
            attachHeaderHandlers();
        };

        // Event delegation for admin UI
        document.body.addEventListener('click', async (e) => {
            if (e.target.closest('.admin-sidebar-link')) { e.preventDefault(); const page = e.target.closest('.admin-sidebar-link').dataset.adminPage; if (page) await renderAdminPanel(page); return; }
            if (e.target.closest('#admin-logout-button')) { e.preventDefault(); try { await auth.signOut(); } catch (err) { console.error('Logout error:', err); } window.location.href = 'index.html'; return; }
            // admin page actions
            const editArticleBtn = e.target.closest('.edit-article-btn'); if (editArticleBtn) { showArticleModal(editArticleBtn.dataset.id); return; }
            const deleteArticleBtn = e.target.closest('.delete-article-btn'); if (deleteArticleBtn) { showDeleteConfirmation('article', deleteArticleBtn.dataset.id); return; }
            const addArticleBtn = e.target.closest('#add-article-btn'); if (addArticleBtn) { showArticleModal(); return; }
            const addCategoryBtn = e.target.closest('#add-category-btn'); if (addCategoryBtn) { showCategoryModal(); return; }
            const editCategoryBtn = e.target.closest('.edit-category-btn'); if (editCategoryBtn) { showCategoryModal(editCategoryBtn.dataset.id); return; }
            const deleteCategoryBtn = e.target.closest('.delete-category-btn'); if (deleteCategoryBtn) { showDeleteConfirmation('category', deleteCategoryBtn.dataset.id); return; }
            const addPathBtn = e.target.closest('#add-path-btn'); if (addPathBtn) { showPathModal(); return; }
            const editPathBtn = e.target.closest('.edit-path-btn'); if (editPathBtn) { showPathModal(editPathBtn.dataset.id); return; }
            const deletePathBtn = e.target.closest('.delete-path-btn'); if (deletePathBtn) { showDeleteConfirmation('path', deletePathBtn.dataset.id); return; }
            const replyCommentBtn = e.target.closest('.reply-comment-btn'); if (replyCommentBtn) { showCommentModal(replyCommentBtn.dataset.id); return; }
            const approveCommentBtn = e.target.closest('.approve-comment-btn'); if (approveCommentBtn) { try { await firestore.collection('comments').doc(approveCommentBtn.dataset.id).update({ approved: true }); dbCache.comments = await fetchCollection('comments'); await renderAdminPanel('comments'); } catch (err) { console.error('Gagal approve komentar:', err); if (isPermissionDenied(err)) showFirestorePermissionModal('comments'); } return; }
            const deleteCommentBtn = e.target.closest('.delete-comment-btn'); if (deleteCommentBtn) { showDeleteConfirmation('comment', deleteCommentBtn.dataset.id); return; }
            const addToolBtn = e.target.closest('#add-tool-btn'); if (addToolBtn) { showToolModal(); return; }
            const editToolBtn = e.target.closest('.edit-tool-btn'); if (editToolBtn) { showToolModal(editToolBtn.dataset.id); return; }
            const deleteToolBtn = e.target.closest('.delete-tool-btn'); if (deleteToolBtn) { showDeleteConfirmation('tool', deleteToolBtn.dataset.id); return; }
        });

        // Auth state and admin claim check
        const checkAdminClaims = async (user) => { try { if (!user) { appState.isAdmin = false; return false; } const idTokenResult = await user.getIdTokenResult(true); appState.isAdmin = !!(idTokenResult && idTokenResult.claims && idTokenResult.claims.admin === true); return appState.isAdmin; } catch (err) { console.error('Failed to check admin claims:', err); appState.isAdmin = false; return false; } };

        auth.onAuthStateChanged(async (user) => {
            if (user) { await checkAdminClaims(user); appState.isLoggedIn = true; // preload caches
                try { [dbCache.categories, dbCache.learningPaths, dbCache.tools, dbCache.comments] = await Promise.all([ fetchCollection('categories'), fetchCollection('learningPaths'), fetchCollection('tools'), fetchCollection('comments') ]); } catch (e) { console.error('Failed preloading admin caches', e); }
                if (!appState.isAdmin) { modalContainer.innerHTML = `<div class="modal-overlay"><div class="bg-white p-6 rounded-lg max-w-md"><h3 class="text-lg font-bold">Akses Ditolak</h3><p>Akun ini bukan admin.</p><div class="mt-4"><button id="close-acc" class="bg-gray-200 px-3 py-1 rounded">Tutup</button></div></div></div>`; document.getElementById('close-acc').addEventListener('click', () => { modalContainer.innerHTML = ''; auth.signOut(); window.location.href = 'index.html'; }); return; }
                // set header user info (email + avatar initials)
                try {
                    const userNameEl = document.getElementById('header-admin-user');
                    const avatarEl = document.getElementById('header-admin-avatar');
                    if (userNameEl) userNameEl.textContent = user.email || user.displayName || 'Admin';
                    if (avatarEl) {
                        const initials = (user.displayName || user.email || 'A').split(' ').map(s=>s[0]).join('').slice(0,2).toUpperCase();
                        avatarEl.src = `https://placehold.co/40x40/111827/fff?text=${encodeURIComponent(initials)}`;
                    }
                } catch(e) { console.error('Failed to set header user info', e); }
                await renderAdminPanel('dashboard');
            } else { appState.isLoggedIn = false; // hide header on login form
                hideHeader();
                pageContent.innerHTML = document.getElementById('admin-login-page-template').innerHTML; document.getElementById('admin-login-form').addEventListener('submit', async (e) => { e.preventDefault(); const email = document.getElementById('username').value; const password = document.getElementById('password').value; const errorMsg = document.getElementById('login-error'); try { await firebase.auth().signInWithEmailAndPassword(email, password); errorMsg.classList.add('hidden'); } catch (err) { console.error('Auth signIn error:', err); errorMsg.textContent = err.message || 'Gagal login.'; errorMsg.classList.remove('hidden'); } }); }
        });

        // Attach handlers for header buttons (logout and back)
        function attachHeaderHandlers() {
            try {
                const headerLogout = document.getElementById('header-admin-logout-button');
                if (headerLogout && !headerLogout.dataset.handlerAttached) {
                    headerLogout.addEventListener('click', async (e) => {
                        e.preventDefault();
                        try { await auth.signOut(); showToast('Anda telah logout'); } catch (err) { console.error('Logout error:', err); showToast('Logout gagal', 'error'); }
                        setTimeout(()=> window.location.href = 'index.html', 600);
                    });
                    headerLogout.dataset.handlerAttached = '1';
                }
                const headerBack = document.getElementById('header-admin-back');
                if (headerBack && !headerBack.dataset.handlerAttached) {
                    headerBack.addEventListener('click', (e) => {
                        e.preventDefault();
                        window.location.href = 'index.html';
                    });
                    headerBack.dataset.handlerAttached = '1';
                }
                // mobile toggles
                const mobileToggle = document.getElementById('admin-mobile-toggle');
                const mobileSidebar = document.getElementById('mobile-sidebar');
                const mobileClose = document.getElementById('mobile-sidebar-close');
                const mobileLogout = document.getElementById('mobile-logout');
                if (mobileToggle && !mobileToggle.dataset.handlerAttached) {
                    mobileToggle.addEventListener('click', (e) => {
                        e.preventDefault(); if (mobileSidebar) mobileSidebar.classList.remove('hidden');
                    });
                    mobileToggle.dataset.handlerAttached = '1';
                }
                if (mobileClose && !mobileClose.dataset.handlerAttached) {
                    mobileClose.addEventListener('click', (e) => { e.preventDefault(); if (mobileSidebar) mobileSidebar.classList.add('hidden'); });
                    mobileClose.dataset.handlerAttached = '1';
                }
                if (mobileSidebar && !mobileSidebar.dataset.handlerAttached) {
                    mobileSidebar.addEventListener('click', (ev) => { if (ev.target === mobileSidebar) mobileSidebar.classList.add('hidden'); });
                    mobileSidebar.dataset.handlerAttached = '1';
                }
                if (mobileLogout && !mobileLogout.dataset.handlerAttached) {
                    mobileLogout.addEventListener('click', async (e) => { e.preventDefault(); try { await auth.signOut(); showToast('Anda telah logout'); } catch (err) { console.error(err); showToast('Logout gagal', 'error'); } setTimeout(()=> window.location.href = 'index.html', 600); });
                    mobileLogout.dataset.handlerAttached = '1';
                }
            } catch (e) { console.error('attachHeaderHandlers error:', e); }
        }

        // Simple toast helper
        function showToast(message, type='info', duration=3000) {
            try {
                const container = document.getElementById('toast-container'); if (!container) return;
                const id = 'toast-' + Date.now(); const bg = type === 'error' ? 'bg-red-600' : 'bg-gray-800';
                const el = document.createElement('div'); el.id = id; el.className = `text-white px-4 py-2 rounded shadow ${bg} mb-2 opacity-0 transform translate-y-4 transition-all`;
                el.textContent = message; container.appendChild(el);
                requestAnimationFrame(()=>{ el.classList.remove('opacity-0'); el.classList.remove('translate-y-4'); el.style.opacity = '1'; el.style.transform = 'translateY(0)'; });
                setTimeout(()=>{ el.style.opacity = '0'; el.style.transform = 'translateY(8px)'; setTimeout(()=> el.remove(), 300); }, duration);
            } catch(e) { console.error('toast error', e); }
        }

        // Init: render login if not logged
        if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', () => { if (!auth.currentUser) pageContent.innerHTML = document.getElementById('admin-login-page-template').innerHTML; });

    </script>

</body>
</html>

<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jalur QA - Platform Belajar SQA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- DOMPurify: sanitize HTML from editor before rendering -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@2.4.0/dist/purify.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Style untuk blok kode */
        pre {
            background-color: #2d3748; /* gray-800 */
            color: #e2e8f0; /* gray-300 */
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            font-size: 0.9em;
        }
        code {
            font-family: 'Courier New', Courier, monospace;
            background-color: #e2e8f0;
            padding: 0.1rem 0.3rem;
            border-radius: 0.25rem;
        }
        pre code {
            background-color: transparent;
            padding: 0;
            border-radius: 0;
        }
        /* Efek scroll yang lebih halus */
        html {
            scroll-behavior: smooth;
        }
        .admin-sidebar-link {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s ease-in-out;
            cursor: pointer;
        }
        .admin-sidebar-link:hover, .admin-sidebar-link.active {
            background-color: #3b82f6; /* blue-500 */
            color: white;
        }
        /* Styling untuk modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        /* Article content styles to preserve whitespace and list markers */
        .article-body {
            white-space: pre-wrap; /* preserve newlines and wrap long lines */
            word-break: break-word;
            line-height: 1.7;
        }
        .article-body ol, .article-body ul {
            margin-left: 1.25rem;
            padding-left: 1rem;
        }
        /* Force list markers to be visible and properly indented */
        .article-body ol {
            list-style-type: decimal;
            list-style-position: outside;
            padding-left: 1.5rem;
        }
        .article-body li {
            display: list-item;
            list-style-type: inherit;
            list-style-position: outside;
        }
        .article-body ol ol { padding-left: 1.25rem; }
        /* Support Quill's indent classes so nested lists and indents render similarly to editor */
        .article-body .ql-indent-1 { margin-left: 1.25rem; }
        .article-body .ql-indent-2 { margin-left: 2.5rem; }
        .article-body .ql-indent-3 { margin-left: 3.5rem; }
        .article-body ol { list-style-position: outside; }
        .article-body li {
            margin-bottom: 0.5rem;
        }
        .article-body pre { white-space: pre-wrap; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="app">
        <!-- ===== HEADER / NAVIGASI ===== -->
        <header id="main-header" class="bg-white shadow-md sticky top-0 z-50">
            <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
                <a href="#" class="nav-link text-2xl font-bold text-blue-600" data-page="home">Jalur QA</a>
                <div class="hidden md:flex space-x-6 items-center">
                    <a href="#" class="nav-link text-gray-600 hover:text-blue-600" data-page="home">Beranda</a>
                    <a href="#" class="nav-link text-gray-600 hover:text-blue-600" data-page="blog">Artikel</a>
                    <a href="#" class="nav-link text-gray-600 hover:text-blue-600" data-page="paths">Jalur Belajar</a>
                    <a href="#" class="nav-link text-gray-600 hover:text-blue-600" data-page="tools">Tools</a>
                    <a href="#" class="nav-link text-gray-600 hover:text-blue-600" data-page="about">Tentang Saya</a>
                </div>
            <!-- admin login removed from public header; use index.html/adminat to access admin -->
                <button id="mobile-menu-button" class="md:hidden">
                    <i data-lucide="menu"></i>
                </button>
            </nav>
            <!-- Menu Mobile -->
            <div id="mobile-menu" class="hidden md:hidden px-6 pb-4">
                <a href="#" class="nav-link block py-2 text-gray-600 hover:text-blue-600" data-page="home">Beranda</a>
                <a href="#" class="nav-link block py-2 text-gray-600 hover:text-blue-600" data-page="blog">Artikel</a>
                <a href="#" class="nav-link block py-2 text-gray-600 hover:text-blue-600" data-page="paths">Jalur Belajar</a>
                <a href="#" class="nav-link block py-2 text-gray-600 hover:text-blue-600" data-page="tools">Tools</a>
                <a href="#" class="nav-link block py-2 text-gray-600 hover:text-blue-600" data-page="about">Tentang Saya</a>
                      <!-- mobile admin link removed; use index.html/adminat to access admin -->
            </div>
        </header>

        <main id="page-content">
            <!-- Halaman akan dirender di sini oleh JavaScript -->
        </main>

        <!-- ===== FOOTER ===== -->
        <footer class="bg-gray-800 text-white mt-16">
            <div class="container mx-auto px-6 py-8 text-center">
                <p>&copy; 2025 Jalur QA. All Rights Reserved.</p>
                <div class="flex justify-center space-x-4 mt-4">
                    <a href="#" class="hover:text-blue-400"><i data-lucide="linkedin"></i></a>
                    <a href="#" class="hover:text-blue-400"><i data-lucide="globe"></i></a>
                </div>
            </div>
        </footer>
    </div>
    
    <!-- MODAL CONTAINER (Awalnya disembunyikan) -->
    <div id="modal-container"></div>


    <!-- ===== TEMPLATE HALAMAN (disembunyikan secara default) ===== -->
    <template id="home-page-template">
        <div class="fade-in">
            <!-- Hero Section -->
            <section class="bg-blue-600 text-white">
                <div class="container mx-auto px-6 py-24 text-center">
                    <h1 class="text-4xl md:text-5xl font-bold mb-4">Kuasai Software Quality Assurance dari Praktisi Ahli</h1>
                    <p class="text-lg md:text-xl mb-8 max-w-3xl mx-auto text-blue-100">Pelajari fundamental, automasi, hingga best practice di dunia QA melalui panduan praktis dan studi kasus nyata.</p>
                    <a href="#" class="nav-link bg-white text-blue-600 font-bold py-3 px-8 rounded-full hover:bg-blue-100 transition text-lg" data-page="paths">Mulai Belajar Sekarang</a>
                </div>
            </section>

            <!-- Artikel Terbaru -->
            <section class="container mx-auto px-6 py-16">
                <h2 class="text-3xl font-bold text-center mb-10">Artikel Terbaru</h2>
                <div id="latest-articles" class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <!-- Kartu Artikel akan di-render di sini -->
                </div>
                <div class="text-center mt-12">
                     <a href="#" class="nav-link bg-blue-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-blue-600 transition" data-page="blog">Lihat Semua Artikel</a>
                </div>
            </section>

            <!-- Jalur Belajar Unggulan -->
            <section class="bg-gray-100">
                <div class="container mx-auto px-6 py-16">
                    <h2 class="text-3xl font-bold text-center mb-10">Jalur Belajar Unggulan</h2>
                    <div id="featured-paths" class="grid md:grid-cols-2 gap-8 max-w-4xl mx-auto">
                        <!-- Kartu Jalur Belajar akan di-render di sini -->
                    </div>
                </div>
            </section>

            <!-- Tentang Penulis -->
            <section class="container mx-auto px-6 py-16">
                 <div class="max-w-4xl mx-auto bg-white p-8 rounded-xl shadow-lg flex flex-col md:flex-row items-center gap-8">
                    <img src="foto.jpg" alt="Foto Penulis" class="w-36 h-36 rounded-full object-cover">
                    <div>
                        <h3 class="text-2xl font-bold mb-2">Tentang Saya</h3>
                        <p class="text-gray-600 mb-4">Welcome to QA Path! I am a dedicated Software Quality Assurance Engineer with a strong passion for knowledge sharing.</p>
                        <a href="#" class="nav-link text-blue-600 font-semibold flex items-center gap-2" data-page="about">
                            Pelajari Lebih Lanjut <i data-lucide="arrow-right" class="w-5 h-5"></i>
                        </a>
                    </div>
                </div>
            </section>
        </div>
    </template>

    <template id="blog-page-template">
        <div class="container mx-auto px-6 py-12 fade-in">
            <h1 class="text-4xl font-bold text-center mb-4">Semua Artikel</h1>
            <p class="text-center text-gray-600 mb-12 max-w-2xl mx-auto">Jelajahi semua artikel yang telah kami publikasikan. Gunakan pencarian dan filter untuk menemukan topik yang Anda minati.</p>

            <!-- Fitur Pencarian dan Filter -->
            <div class="flex flex-col md:flex-row gap-4 mb-10">
                <input type="text" id="search-input" placeholder="Cari artikel..." class="w-full md:w-2/3 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <select id="category-filter" class="w-full md:w-1/3 px-4 py-2 border rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <!-- Opsi Kategori akan di-render di sini -->
                </select>
            </div>

            <!-- Grid Artikel -->
            <div id="articles-grid" class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
                <!-- Hasil pencarian dan filter akan di-render di sini -->
            </div>
             <div id="no-results" class="hidden text-center py-16 text-gray-500">
                <p class="text-xl">Artikel tidak ditemukan.</p>
            </div>
        </div>
    </template>
    
    <template id="article-page-template">
         <div class="container mx-auto px-6 py-12 fade-in">
            <div class="flex flex-col lg:flex-row gap-12">
                <!-- Konten Artikel -->
                <article class="w-full lg:w-3/4">
                    <div id="article-content-wrapper">
                        <!-- Konten detail artikel akan di-render di sini -->
                    </div>
                </article>

                <!-- Daftar Isi (Table of Contents) -->
                <aside class="w-full lg:w-1/4 lg:sticky top-24 self-start">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="font-bold text-lg mb-4">Daftar Isi</h3>
                        <ul id="toc-list" class="space-y-2 text-gray-600">
                           <!-- TOC akan di-render di sini -->
                        </ul>
                    </div>
                </aside>
            </div>
        </div>
    </template>

    <template id="paths-page-template">
        <div class="container mx-auto px-6 py-12 fade-in">
             <h1 class="text-4xl font-bold text-center mb-4">Jalur Belajar SQA</h1>
            <p class="text-center text-gray-600 mb-12 max-w-2xl mx-auto">Ikuti alur pembelajaran yang telah kami susun secara sistematis untuk membantu Anda menguasai SQA dari dasar hingga mahir.</p>
            <div id="paths-list" class="grid md:grid-cols-2 gap-8 max-w-5xl mx-auto">
                 <!-- Daftar semua learning paths akan di-render di sini -->
            </div>
        </div>
    </template>
    
    <template id="path-detail-page-template">
        <div class="container mx-auto px-6 py-12 fade-in">
             <div id="path-detail-content" class="max-w-4xl mx-auto">
                 <!-- Detail learning path akan di-render di sini -->
             </div>
        </div>
    </template>

    <template id="about-page-template">
        <div class="container mx-auto px-6 py-12 fade-in">
            <div class="max-w-4xl mx-auto bg-white p-8 md:p-12 rounded-xl shadow-lg">
                <div class="text-center">
                    <img src="foto.jpg" alt="Foto Penulis" class="w-48 h-48 rounded-full object-cover mx-auto mb-6">
                    <h1 class="text-4xl font-bold">Angga Trianto</h1>
                    <p class="text-xl text-gray-500">Software Quality Assurance Engineer</p>
                </div>
                 <div class="mt-10 text-lg text-gray-700 leading-relaxed space-y-4">
                    <p>Welcome to QA Path! I am a dedicated Software Quality Assurance Engineer with a strong passion for knowledge sharing.</p>
                    <p>Throughout my career, I've recognized the critical role of QA in ensuring the quality of digital products. However, I also noticed a significant gap in structured, Indonesian-language learning resources for this field.</p>
                    <p>I created this platform to serve as a bridge for aspiring and current professionals looking to start or advance their careers in Quality Assurance. Here, I will share practical insights drawn from my hands-on experience, covering everything from fundamental concepts and tool proficiency to effective testing strategies.</p>
                    <p>My vision is to foster a solid and collaborative Indonesian SQA community where we can all learn from one another and grow together professionally.</p>
                    <p>Thank you for visiting. I hope you find the content valuable on your learning journey.</p>
                </div>
            </div>
        </div>
    </template>

    <template id="tools-page-template">
        <div class="container mx-auto px-6 py-12 fade-in">
             <h1 class="text-4xl font-bold text-center mb-4">Tools SQA</h1>
            <p class="text-center text-gray-600 mb-12 max-w-2xl mx-auto">Jelajahi berbagai tools yang umum digunakan dalam dunia Software Quality Assurance untuk mempermudah pekerjaan Anda.</p>
            <div id="tools-list" class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
                 <!-- Daftar tools akan di-render di sini -->
            </div>
        </div>
    </template>
    
    <script type="module">
        // Public-only script: Firebase init (compat) + public rendering & routing.
        // Admin shortcut: if URL path ends with /adminat or hash is #adminat -> redirect to admin.html
        try {
            const p = window.location.pathname || '';
            if (p.endsWith('/adminat') || p.endsWith('/adminat/')) {
                window.location.href = window.location.pathname.replace(/\/adminat\/?$/, '') + '/admin.html';
            }
            if (window.location.hash === '#adminat') {
                window.location.href = 'admin.html';
            }
        } catch (e) { console.error('admin shortcut check failed', e); }
        window.addEventListener('error', (ev) => {
            console.error('Runtime error caught:', ev.error || ev.message || ev);
            try { document.getElementById('modal-container').innerHTML = `<div class="modal-overlay"><div class="bg-white rounded-lg p-6 max-w-xl"><h3 class="text-xl font-bold mb-2">Runtime Error</h3><pre style="white-space:pre-wrap;">${(ev.error && ev.error.stack) || ev.message || ev}</pre><div class="mt-4"><button onclick="document.getElementById('modal-container').innerHTML='';" class="bg-blue-500 text-white py-2 px-4 rounded">Tutup</button></div></div></div>`; } catch (e) { }
        });
        window.addEventListener('unhandledrejection', (ev) => {
            console.error('Unhandled rejection:', ev.reason);
            try { document.getElementById('modal-container').innerHTML = `<div class="modal-overlay"><div class="bg-white rounded-lg p-6 max-w-xl"><h3 class="text-xl font-bold mb-2">Unhandled Rejection</h3><pre style="white-space:pre-wrap;">${ev.reason && ev.reason.stack ? ev.reason.stack : JSON.stringify(ev.reason)}</pre><div class="mt-4"><button onclick="document.getElementById('modal-container').innerHTML='';" class="bg-blue-500 text-white py-2 px-4 rounded">Tutup</button></div></div></div>`; } catch (e) { }
        });

        const addFirebaseScripts = () => {
            const head = document.getElementsByTagName('head')[0];
            const s1 = document.createElement('script'); s1.src = 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js'; head.appendChild(s1);
            const s2 = document.createElement('script'); s2.src = 'https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js'; head.appendChild(s2);
            // auth compat not needed on public page; admin.html handles authentication
            // include shared helpers
            const s3 = document.createElement('script'); s3.src = './shared.js'; head.appendChild(s3);
        };
        addFirebaseScripts();

        const firebaseConfig = {
            apiKey: "AIzaSyC4i7BuTVHx7EaQxyn3Dlv83HTVdtgn9Ik",
            authDomain: "jalur-qa.firebaseapp.com",
            projectId: "jalur-qa",
            storageBucket: "jalur-qa.appspot.com",
            messagingSenderId: "928716547519",
            appId: "1:928716547519:web:10f2e2cd1d84e1f5ca2d0a"
        };

        const waitForFirebase = () => new Promise(resolve => {
            const check = () => { if (window.firebase && window.firebase.firestore) return resolve(); setTimeout(check, 50); };
            check();
        });

        // Initialize Firebase after compat scripts load. Use promise-based init so the module
        // doesn't block the page if scripts are slow or blocked by network.
        let firestore = null;
        waitForFirebase().then(() => {
            try {
                if (window.sharedHelpers && typeof window.sharedHelpers.initFirebase === 'function') {
                    window.sharedHelpers.initFirebase(firebaseConfig);
                    firestore = window.sharedHelpers.firestore;
                    window.publicFirestore = firestore;
                } else {
                    firebase.initializeApp(firebaseConfig);
                    firestore = firebase.firestore();
                    window.publicFirestore = firestore; // expose for debug
                }
                console.log('Firebase compat initialized (public page), firestore ready:', !!firestore);
            } catch (e) {
                console.error('Firebase init failed:', e);
            }
            // start the app once scripts loaded (and DOM ready)
            if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', initApp);
            else initApp();
        }).catch((e) => { console.error('waitForFirebase failed:', e); if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', initApp); else initApp(); });

        // lightweight cache for read-only data
        let dbCache = { categories: [], learningPaths: [], tools: [], comments: [] };

        const appState = { currentPage: 'home', dataLoaded: false };

        const pageContent = document.getElementById('page-content');
        const mainHeader = document.getElementById('main-header');
        const mobileMenu = document.getElementById('mobile-menu');
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const modalContainer = document.getElementById('modal-container');

        const fetchCollection = async (collectionName, options = {}) => {
            // options: { orderBy: 'field', direction: 'desc' }
            let q = firestore.collection(collectionName);
            if (options.orderBy) q = q.orderBy(options.orderBy, options.direction || 'asc');
            const snapshot = await q.get();
            return snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
        };

        const loadInitialData = async () => {
            if (appState.dataLoaded) return;
            try {
                const [categories, learningPaths, tools, comments] = await Promise.all([
                    fetchCollection('categories'), fetchCollection('learningPaths'), fetchCollection('tools'), fetchCollection('comments')
                ]);
                dbCache.categories = categories; dbCache.learningPaths = learningPaths; dbCache.tools = tools; dbCache.comments = comments;
                appState.dataLoaded = true;
            } catch (err) {
                console.error('Gagal memuat data awal:', err);
                pageContent.innerHTML = `<p class="text-center text-red-500 p-8">Gagal terhubung ke database. Pastikan aturan keamanan Firestore sudah benar.</p>`;
            }
        };

        const extractYouTubeId = (url) => {
            if (!url) return null;
            try {
                const u = url.trim();
                const m1 = u.match(/[?&]v=([a-zA-Z0-9_-]{6,})/); if (m1 && m1[1]) return m1[1];
                const m2 = u.match(/youtu\.be\/([a-zA-Z0-9_-]{6,})/); if (m2 && m2[1]) return m2[1];
                const m3 = u.match(/embed\/([a-zA-Z0-9_-]{6,})/); if (m3 && m3[1]) return m3[1];
                return null;
            } catch (e) { return null; }
        };
        const isYouTubeUrl = (url) => !!extractYouTubeId(url);

        const getCategoryName = (id) => dbCache.categories.find(c => c.id === id)?.name || 'Tanpa Kategori';

        // Helpers to detect placeholder image services and generate a random pastel color
        const isPlaceholderUrl = (url) => {
            if (!url) return false;
            const u = String(url).toLowerCase();
            return u.includes('placehold.co') || u.includes('placehold.it') || u.includes('via.placeholder.com');
        };
        const getRandomColor = (seed) => {
            // produce a consistent pastel color from an optional seed string
            let h = 0;
            if (seed) {
                for (let i = 0; i < seed.length; i++) h = (h << 5) - h + seed.charCodeAt(i);
                h = Math.abs(h) % 360;
            } else {
                h = Math.floor(Math.random() * 360);
            }
            return `hsl(${h}deg 70% 85%)`;
        };

        const renderArticleCard = (article) => {
            const hasImage = article.image && String(article.image).trim() !== '';
            const categoryName = getCategoryName(article.categoryId);
            if (hasImage) {
                return `
                <div class="bg-white rounded-xl shadow-lg overflow-hidden transform hover:-translate-y-2 transition-transform duration-300">
                    <img src="${article.image}" alt="${article.title}" class="w-full h-48 object-cover">
                    <div class="p-6">
                        <span class="text-blue-500 font-semibold text-sm">${categoryName}</span>
                        <h3 class="font-bold text-xl mt-2 mb-3 h-14 overflow-hidden">${article.title}</h3>
                        <p class="text-gray-600 text-sm h-10 overflow-hidden">${article.excerpt}</p>
                        <a href="#" class="nav-link text-blue-600 font-semibold mt-4 inline-block" data-page="article" data-id="${article.id}">Baca Selengkapnya &rarr;</a>
                    </div>
                </div>`;
            }
            return `
                <div class="bg-white rounded-xl shadow-lg overflow-hidden transform hover:-translate-y-2 transition-transform duration-300">
                    <div class="w-full h-48 flex items-center justify-center bg-gradient-to-br from-blue-50 to-blue-100">
                        <div class="text-center px-4">
                            <h3 class="font-bold text-xl">${article.title}</h3>
                            <p class="text-blue-600 font-semibold mt-2">${categoryName}</p>
                        </div>
                    </div>
                    <div class="p-6">
                        <p class="text-gray-600 text-sm h-10 overflow-hidden">${article.excerpt}</p>
                        <a href="#" class="nav-link text-blue-600 font-semibold mt-4 inline-block" data-page="article" data-id="${article.id}">Baca Selengkapnya &rarr;</a>
                    </div>
                </div>`;
        };

        const renderPathCard = (path) => {
            // Use a special start-path action: we'll resolve the first available article at click-time
            const hasImage = path.image && String(path.image).trim() !== '';
            const imageIsPlaceholder = hasImage && isPlaceholderUrl(path.image);
            if (hasImage && !imageIsPlaceholder) {
                return `
                <a href="#" class="nav-link block" data-page="start-path" data-id="${path.id}">
                  <div class="bg-white rounded-xl shadow-lg overflow-hidden transform hover:-translate-y-2 transition-transform duration-300">
                      <div class="relative w-full h-48 md:h-56 lg:h-48">
                          <img src="${path.image}" alt="${path.title}" class="w-full h-full object-cover" />
                          <div class="absolute inset-0 bg-gray-700 bg-opacity-60 flex items-center justify-center" role="img" aria-label="${path.title}">
                              <h3 class="text-white font-bold text-xl md:text-2xl px-4 text-center" tabindex="0">${path.title}</h3>
                          </div>
                      </div>
                      <div class="p-6">
                          <p class="text-gray-600 mb-4">${path.description}</p>
                          <div class="text-right"><span class="bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg">Mulai Belajar</span></div>
                      </div>
                  </div>
                </a>`;
            }
            // either no image or placeholder URL -> render a solid random pastel background
            // use a consistent dark-gray background so title is readable and uniform
            return `
            <a href="#" class="nav-link block" data-page="start-path" data-id="${path.id}">
              <div class="bg-white rounded-xl shadow-lg overflow-hidden transform hover:shadow-2xl transition-shadow duration-300">
                  <div class="w-full h-48 md:h-56 lg:h-48 flex items-center justify-center bg-gray-700">
                      <h3 class="text-white font-bold text-xl md:text-2xl px-4 text-center">${path.title}</h3>
                  </div>
                  <div class="p-6">
                      <p class="text-gray-600 mb-4">${path.description}</p>
                      <div class="text-right"><span class="bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg">Mulai Belajar</span></div>
                  </div>
              </div>
            </a>`;
                        return `
                        <a href="#" class="nav-link block" data-page="start-path" data-id="${path.id}">
                            <div class="bg-white rounded-xl shadow-lg overflow-hidden transform hover:shadow-2xl transition-shadow duration-300">
                                    <div class="p-6">
                                            <h3 class="font-bold text-xl mb-2">${path.title}</h3>
                                            <p class="text-gray-600 mb-4">${path.description}</p>
                                            <div class="text-right"><span class="bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg">Mulai Belajar</span></div>
                                    </div>
                            </div>
                        </a>`;
        };

        // Try to navigate to the first existing article in a learning path.
        const startPath = async (pathId) => {
            try {
                const doc = await firestore.collection('learningPaths').doc(pathId).get();
                if (!doc.exists) { navigateTo('paths'); return; }
                const path = { id: doc.id, ...doc.data() };
                const ids = Array.isArray(path.articles) ? path.articles : [];
                for (let aid of ids) {
                    try {
                        const aDoc = await firestore.collection('articles').doc(aid).get();
                        if (aDoc.exists) { navigateTo('article', aDoc.id); return; }
                    } catch (e) { console.warn('Failed checking article', aid, e); }
                }
                // no available article found, fall back to path detail
                navigateTo('path-detail', path.id);
            } catch (err) { console.error('startPath failed', err); navigateTo('path-detail', pathId); }
        };

        const renderHomePage = async () => {
            pageContent.innerHTML = document.getElementById('home-page-template').innerHTML;
            // fetch latest articles ordered by date descending
            let articles = [];
            try { articles = await fetchCollection('articles', { orderBy: 'date', direction: 'desc' }); } catch (e) { articles = await fetchCollection('articles'); }
            document.getElementById('latest-articles').innerHTML = (articles || []).slice(0,3).map(renderArticleCard).join('');
            document.getElementById('featured-paths').innerHTML = dbCache.learningPaths.slice(0,2).map(renderPathCard).join('');
            // record a visitor (throttled)
            try { recordVisit().catch(()=>{}); } catch(e){}
        };

        // Visitor tracking: best-effort client-side record using ipapi.co (may not work on file://)
        const recordVisit = async () => {
            try {
                // avoid recording too frequently per session
                if (sessionStorage.getItem('lastVisitRecorded')) return;
                let country = 'unknown';
                try {
                    const r = await fetch('https://ipapi.co/json/');
                    if (r.ok) {
                        const j = await r.json(); country = j.country_name || j.country || 'unknown';
                    }
                } catch (e) { /* ignore network failures */ }
                const docRef = firestore.collection('visitors').doc(country);
                await firestore.runTransaction(async (tx) => {
                    const doc = await tx.get(docRef);
                    if (!doc.exists) tx.set(docRef, { country, count: 1, updatedAt: firebase.firestore.Timestamp.now() });
                    else tx.update(docRef, { count: (doc.data().count || 0) + 1, updatedAt: firebase.firestore.Timestamp.now() });
                });
                sessionStorage.setItem('lastVisitRecorded', String(Date.now()));
            } catch (e) { console.warn('recordVisit failed', e); }
        };

        // helper to read aggregated visitor stats
        const fetchVisitorStats = async () => {
            try {
                const snap = await firestore.collection('visitors').orderBy('count','desc').get();
                return snap.docs.map(d => ({ id: d.id, ...d.data() }));
            } catch (e) { console.warn('fetchVisitorStats failed', e); return []; }
        };

        const renderBlogPage = async (articlesToRender = null) => {
            pageContent.innerHTML = document.getElementById('blog-page-template').innerHTML;
            const grid = document.getElementById('articles-grid'); const noResults = document.getElementById('no-results'); const categoryFilter = document.getElementById('category-filter');
            categoryFilter.innerHTML = `<option value="all">Semua Kategori</option>` + dbCache.categories.map(cat => `<option value="${cat.id}">${cat.name}</option>`).join('');
            // restore previous selected category if any
            try { if (appState.currentCategory) categoryFilter.value = appState.currentCategory; else categoryFilter.value = 'all'; } catch(e) { categoryFilter.value = 'all'; }
            const articles = articlesToRender || await fetchCollection('articles', { orderBy: 'date', direction: 'desc' });
            if (articles.length > 0) { grid.innerHTML = articles.map(renderArticleCard).join(''); grid.classList.remove('hidden'); noResults.classList.add('hidden'); }
            else { grid.classList.add('hidden'); noResults.classList.remove('hidden'); }
            document.getElementById('search-input').addEventListener('input', handleFilterAndSearch);
            document.getElementById('category-filter').addEventListener('change', handleFilterAndSearch);
        };

        const handleFilterAndSearch = async () => {
            const searchTerm = (document.getElementById('search-input').value || '').toLowerCase();
            const categoryId = document.getElementById('category-filter').value;
            appState.currentCategory = categoryId;
            const allArticles = await fetchCollection('articles', { orderBy: 'date', direction: 'desc' });
            const filtered = allArticles.filter(article => {
                const title = (article.title || '').toString().toLowerCase();
                const excerpt = (article.excerpt || '').toString().toLowerCase();
                const matchesSearch = title.includes(searchTerm) || excerpt.includes(searchTerm);
                const matchesCategory = categoryId === 'all' || article.categoryId == categoryId;
                return matchesSearch && matchesCategory;
            });
            renderBlogPage(filtered);
        };

        const renderArticlePage = async (id) => {
            const articleRef = await firestore.collection('articles').doc(id).get(); if (!articleRef.exists) { navigateTo('home'); return; }
            const article = { id: articleRef.id, ...articleRef.data() };
            pageContent.innerHTML = document.getElementById('article-page-template').innerHTML; const wrapper = document.getElementById('article-content-wrapper');
            const date = (article.date && typeof article.date.toDate === 'function') ? article.date.toDate() : new Date(article.date);
            const categoryName = getCategoryName(article.categoryId);
            const safeContent = (window.DOMPurify && typeof DOMPurify.sanitize === 'function') ? DOMPurify.sanitize(article.content || '', {
                ADD_ATTR: ['class','style'],
                ALLOWED_CSS_PROPERTIES: ['font-size','color','background-color','text-align','font-weight','font-style','font-family','margin-left','margin-right','margin-top','margin-bottom','padding-left']
            }) : (article.content || '');
            try { console.log('renderArticlePage: sanitized content snippet ->', (safeContent || '').slice(0,400)); } catch(e) {}
            wrapper.innerHTML = `
                <span class="text-blue-500 font-semibold text-sm">${categoryName}</span>
                <h1 class="text-3xl md:text-4xl font-bold mt-2 mb-4">${article.title}</h1>
                <div class="text-gray-500 text-sm mb-6"><span>Oleh ${article.author}</span> &bull; <span>${date.toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' })}</span></div>
                ${article.image && String(article.image).trim() !== '' ? `<img src="${article.image}" alt="${article.title}" class="w-full rounded-lg mb-8">` : `<div class="w-full h-48 mb-8 flex items-center justify-center bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg"><h2 class="text-2xl font-bold">${article.title}</h2></div>`}
                <div class="article-body max-w-none">${safeContent}</div>
            `;
            const tocList = document.getElementById('toc-list'); const headings = wrapper.querySelectorAll('h2'); tocList.innerHTML = '';
            if (headings.length > 0) { headings.forEach((h,i) => { h.id = `section-${i}`; tocList.innerHTML += `<li><a href="#${h.id}" class="hover:text-blue-600">${h.textContent}</a></li>`; }); tocList.parentElement.style.display = 'block'; }
            else { tocList.parentElement.style.display = 'none'; }
        };

        const renderToolPage = async (id) => {
            const docSnap = await firestore.collection('tools').doc(id).get(); if (!docSnap.exists) { navigateTo('tools'); return; }
            const tool = { id: docSnap.id, ...docSnap.data() };
            pageContent.innerHTML = `<div class="container mx-auto px-6 py-12 fade-in"><h1 class="text-3xl font-bold mb-4">${tool.title}</h1><p class="text-gray-600 mb-6">${tool.description || ''}</p><div class="grid md:grid-cols-2 gap-6" id="tool-videos-list"></div></div>`;
            const list = document.getElementById('tool-videos-list'); const videos = tool.videos || [];
            if (videos.length === 0) { list.innerHTML = `<div class="col-span-2 text-center text-gray-500">Tidak ada video untuk materi ini.</div>`; return; }
            list.innerHTML = videos.map((v,i) => { const vid = extractYouTubeId(v); const thumb = vid ? `https://img.youtube.com/vi/${vid}/mqdefault.jpg` : 'https://placehold.co/160x90/E2E8F0/333?text=No+Image'; return `<div class="bg-white rounded-lg shadow p-4 flex items-center gap-4"><div class="w-36 h-20 relative"><img src="${thumb}" class="w-full h-full object-cover rounded cursor-pointer video-thumb-item" data-video="${v}" data-vid="${vid || ''}" onerror="this.src='https://placehold.co/160x90/E2E8F0/333?text=No+Image'"></div><div class="flex-1"><div class="text-sm font-semibold">${i+1}. ${tool.title || ''}</div><div class="text-xs text-gray-500 mt-1">${v}</div></div></div>`; }).join('');
            list.querySelectorAll('.video-thumb-item').forEach(img => img.addEventListener('click', () => { const v = img.dataset.video; const vid = img.dataset.vid; showVideoPlayer(vid || v); }));
        };

        const showVideoPlayer = (idOrUrl) => {
            const id = extractYouTubeId(idOrUrl) || idOrUrl; const src = `https://www.youtube.com/embed/${id}`;
            modalContainer.innerHTML = `<div class="modal-overlay"><div class="bg-black/80 p-6 rounded-lg max-w-3xl w-full"><div style="position:relative;width:100%;padding-top:56.25%;"><iframe src="${src}" frameborder="0" allowfullscreen style="position:absolute;left:0;top:0;width:100%;height:100%;"></iframe></div><div class="mt-4 text-right"><button id="close-video-player" class="bg-white text-black py-1 px-3 rounded">Tutup</button></div></div></div>`;
            document.getElementById('close-video-player').addEventListener('click', () => { modalContainer.innerHTML = ''; });
        };

        const renderPathsPage = () => { pageContent.innerHTML = document.getElementById('paths-page-template').innerHTML; document.getElementById('paths-list').innerHTML = dbCache.learningPaths.map(renderPathCard).join(''); };
        const renderAboutPage = () => { pageContent.innerHTML = document.getElementById('about-page-template').innerHTML; };
        const renderToolsPage = () => {
            pageContent.innerHTML = document.getElementById('tools-page-template').innerHTML; const list = document.getElementById('tools-list'); list.innerHTML = dbCache.tools.map((tool,idx) => { const title = tool.title || tool.name || 'Untitled Tool'; const description = tool.description || ''; const firstVideo = (tool.videos && tool.videos[0]) || ''; const videoId = extractYouTubeId(firstVideo); const thumb = videoId ? `https://img.youtube.com/vi/${videoId}/hqdefault.jpg` : 'https://placehold.co/600x400/E2E8F0/333?text=No+Image'; return `<a href="#" class="nav-link block" data-page="tool" data-id="${tool.id}"><div class="bg-white rounded-xl shadow-lg overflow-hidden transform hover:-translate-y-2 transition-transform duration-300"><div class="relative w-full h-40 bg-center bg-cover" style="background-image: url('${thumb}');"><div class="absolute inset-0 bg-black bg-opacity-30 flex items-center justify-center"><h3 class="text-white font-bold text-lg px-4 text-center">${title}</h3></div></div><div class="p-6 text-center"><p class="text-gray-600 text-sm mb-2">${description}</p></div></div></a>`; }).join(''); };

        // render detail page for a learning path
        const renderPathDetailPage = async (id) => {
            const doc = await firestore.collection('learningPaths').doc(id).get();
            if (!doc.exists) { navigateTo('paths'); return; }
            const path = { id: doc.id, ...doc.data() };
            pageContent.innerHTML = document.getElementById('path-detail-page-template').innerHTML;
            const wrapper = document.getElementById('path-detail-content');
            const articlesContainer = document.createElement('div');
            articlesContainer.className = 'space-y-4 mt-6';
            // fetch article details listed in the path
            const articleIds = Array.isArray(path.articles) ? path.articles : [];
            let articleRows = [];
            if (articleIds.length > 0) {
                try {
                    const docs = await Promise.all(articleIds.map(aid => firestore.collection('articles').doc(aid).get()));
                    articleRows = docs.filter(d => d.exists).map(d => ({ id: d.id, ...d.data() }));
                } catch (e) { console.error('Failed fetching path articles', e); }
            }
            const headerHtml = `
                <div class="max-w-4xl mx-auto bg-white p-8 rounded-xl shadow-lg">
                    <div class="flex items-center gap-6">
                        <img src="${path.image || 'https://placehold.co/240x160/E2E8F0/333?text=No+Image'}" class="w-48 h-36 object-cover rounded" />
                        <div>
                            <h1 class="text-3xl font-bold">${path.title}</h1>
                            <p class="text-gray-600 mt-2">${path.description || ''}</p>
                        </div>
                    </div>
                </div>`;
            wrapper.innerHTML = headerHtml + `<div id="path-articles-list" class="mt-8 max-w-4xl mx-auto"></div>`;
            const listEl = document.getElementById('path-articles-list');
            if (articleRows.length === 0) {
                listEl.innerHTML = `<div class="bg-white p-6 rounded-lg shadow text-center">Belum ada artikel yang ditambahkan ke jalur ini.</div>`;
            } else {
                listEl.innerHTML = articleRows.map(a => `
                    <a href="#" class="nav-link block bg-white rounded-lg p-4 shadow hover:shadow-md mb-4" data-page="article" data-id="${a.id}">
                        <h3 class="font-bold text-lg">${a.title}</h3>
                        <p class="text-gray-600 text-sm mt-1">${a.excerpt || ''}</p>
                    </a>
                `).join('');
            }
        };

        const renderPage = async (page, id=null) => { switch(page){ case 'home': await renderHomePage(); break; case 'blog': await renderBlogPage(); break; case 'article': await renderArticlePage(id); break; case 'tool': await renderToolPage(id); break; case 'paths': renderPathsPage(); break; case 'path-detail': await renderPathDetailPage(id); break; case 'about': renderAboutPage(); break; case 'tools': renderToolsPage(); break; default: await renderHomePage(); } lucide.createIcons(); };

        const navigateTo = async (page, id = null) => { appState.currentPage = page; window.scrollTo(0,0); if (!appState.dataLoaded) await loadInitialData(); mainHeader.classList.remove('hidden'); await renderPage(page,id); };

        document.body.addEventListener('click', async (e) => {
            const target = e.target.closest('.nav-link');
            if (target) {
                e.preventDefault();
                const page = target.dataset.page;
                const id = target.dataset.id;
                if (page === 'start-path') {
                    // resolve the first existing article before navigating
                    await startPath(id);
                } else {
                    navigateTo(page, id);
                }
                mobileMenu.classList.add('hidden');
                return;
            }
        });

        mobileMenuButton.addEventListener('click', () => mobileMenu.classList.toggle('hidden'));

    const initApp = async () => { try { await navigateTo('home'); } catch (e) { console.error('init failed:', e); } };
    // initApp will be called after Firebase scripts load (see waitForFirebase().then(...) above)
    </script>
</body>
</html>

